generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  // OSP Category
  MANAGER
  OSP_MANAGER
  AREA_MANAGER
  ENGINEER
  ASSISTANT_ENGINEER
  AREA_COORDINATOR
  QC_OFFICER
  // Office Admin Category
  OFFICE_ADMIN
  OFFICE_ADMIN_ASSISTANT
  SITE_OFFICE_STAFF
  // Finance Category
  FINANCE_MANAGER
  FINANCE_ASSISTANT
  // Invoice Section
  INVOICE_MANAGER
  INVOICE_ASSISTANT
  // Stores Category
  STORES_MANAGER
  STORES_ASSISTANT
  // Service Fulfillment
  SA_MANAGER
  SA_ASSISTANT
  PROCUREMENT_OFFICER
}

model OPMC {
  id        String   @id @default(cuid())
  name      String   @default("")
  rtom      String   @unique
  region    String   @default("METRO")
  province  String   @default("METRO 01")
  projects  Project[]
  staff     Staff[]
  users     User[]   @relation("UserOpmcs") // Managed access for users
  serviceOrders ServiceOrder[]
  contractorTeams ContractorTeam[]
  contractors   Contractor[]
  storeId   String? // Store assigned to this OPMC
  store     InventoryStore? @relation(fields: [storeId], references: [id])
  revenueConfigs SODRevenueConfig[] // Revenue configurations for this RTOM
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServiceOrder {
  id                    String   @id @default(cuid())
  rtom                  String
  lea                   String?
  soNum                 String   // SO_NUM - Service Order Number
  voiceNumber           String?
  orderType             String?
  serviceType           String?  // S_TYPE
  customerName          String?  // CON_CUS_NAME
  techContact           String?  // CON_TEC_CONTACT
  status                String   // CON_STATUS
  statusDate            DateTime?
  address               String?
  dp                    String?
  package               String?  // PKG
  ospPhoneClass         String?
  phonePurchase         String?
  sales                 String?  // CON_SALES
  woroTaskName          String?
  iptv                  String?
  woroSeit              String?
  ftthInstSeit          String?
  ftthWifi              String?
  sltsStatus            String   @default("INPROGRESS") // SLTS Status: INPROGRESS, COMPLETED, RETURN
  
  // Scheduling fields
  scheduledDate         DateTime? // Appointment date
  scheduledTime         String?   // Appointment time (e.g., "10:30 AM")
  
  // Comments field
  comments              String?   @db.Text
  
  // Completed/Return date
  completedDate         DateTime? // Date when marked as COMPLETED or RETURN
  
  // Equipment Serial Numbers (for completion)
  ontSerialNumber       String?   // ONT Serial for VOICE_INT packages
  iptvSerialNumbers     String?   @db.Text // JSON array of IPTV serials for VOICE_IPTV packages
  dpDetails             String?   @db.Text // Additional DP-specific details
  
  // PAT details
  patStatus             String?   // Overall status (LEGACY)
  
  sltsPatStatus         String?   @default("PENDING") // Internal: PENDING, PASS, REJECTED
  sltsPatDate           DateTime?
  
  opmcPatStatus         String?   @default("PENDING") // Regional: PENDING, PASS, REJECTED
  opmcPatDate           DateTime?

  hoPatStatus           String?   @default("PENDING") // Head Office: PENDING, PASS, REJECTED
  hoPatDate             DateTime?
  
  isInvoicable          Boolean   @default(false)
  invoiced              Boolean   @default(false)
  invoiceId             String?
  
  // Daily Operational Report Tracking Fields
  wiredOnly             Boolean   @default(false)  // Wired only completion status
  delayReasons          Json?     // { ontShortage: true, stbShortage: false, nokia: false, system: false, opmc: false, cxDelay: false, sameDay: false, polePending: false }
  stbShortage           Boolean   @default(false)  // STB shortage flag
  ontShortage           Boolean   @default(false)  // ONT shortage flag
  ontType               String?   // NEW or EXISTING
  returnReason          String?   @db.Text // Return reason/comment
  completionMode        String?   // 'ONLINE' or 'OFFLINE'
  materialSource        String?   // 'SLT' or 'COMPANY' (Snapshot at completion)
  directTeam            String?   // Internal Team Name (if no contractor)
  photoUrls             String[]  @default([]) // Completion evidence photos
  
  opmcId                String
  opmc                  OPMC     @relation(fields: [opmcId], references: [id], onDelete: Cascade)

  contractorId          String?
  contractor            Contractor? @relation(fields: [contractorId], references: [id])
  
  teamId                String?
  team                  ContractorTeam? @relation(fields: [teamId], references: [id])
  
  restoreRequests       RestoreRequest[]
  materialUsage         SODMaterialUsage[] // Material tracking
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@unique([soNum, status])
  @@index([opmcId])
  @@index([rtom])
  @@index([status])
  @@index([soNum])
  @@index([scheduledDate])
  @@index([contractorId])
  @@index([teamId])
  @@index([sltsStatus])
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  username          String   @unique
  password          String
  name              String?
  role              Role     @default(ENGINEER)
  staffId           String?  @unique
  staff             Staff?   @relation(fields: [staffId], references: [id])
  accessibleOpmcs   OPMC[]   @relation("UserOpmcs")
  requestedRestores RestoreRequest[] @relation("RequestedRestores")
  approvedRestores  RestoreRequest[] @relation("ApprovedRestores")
  auditLogs         AuditLog[]
  
  // Password Reset Security
  securityQuestion  String?
  securityAnswer    String?  // Hashed
  employeeId        String?  // For additional verification
  
  // Hierarchy
  supervisorId      String?
  supervisor        User?    @relation("UserSupervisor", fields: [supervisorId], references: [id])
  subordinates      User[]   @relation("UserSupervisor")

  // Inventory Relations
  managedStores     InventoryStore[]
  requestedStock    StockRequest[]   @relation("RequestUser")
  approvedStock     StockRequest[]   @relation("ApproveUser")
  
  // 3-Tier Approval Relations
  armApprovedRequests           StockRequest[] @relation("ARMApprover")
  storesManagerApprovedRequests StockRequest[] @relation("StoresManagerApprover")
  releasedRequests              StockRequest[] @relation("ReleasedBy")
  receivedRequests              StockRequest[] @relation("ReceivedBy")
  
  receivedGRNs      GRN[]
  returnedMRNs      MRN[]
  approvedMRNs      MRN[]            @relation("MRNApprover")
  stockIssues       StockIssue[]     @relation("StockIssuer")
  approvedIssues    StockIssue[]     @relation("IssueApprover") // Existing StockIssue approval
  
  projectReturns    ProjectMaterialReturn[] @relation("ProjectReturnUser")
  approvedProjectReturns ProjectMaterialReturn[] @relation("ProjectReturnApprover")
  
  // Section Assignments
  sectionAssignments UserSectionAssignment[]

  // Access Scope
  assignedStoreId   String?
  assignedStore     InventoryStore? @relation("UserAssignedStore", fields: [assignedStoreId], references: [id])

  // Contractor Management
  armApprovedContractors    Contractor[] @relation("ContractorArmApproval")
  ospApprovedContractors    Contractor[] @relation("ContractorOspApproval")
  rejectedContractors       Contractor[] @relation("ContractorRejection")
  generatedContractorLinks  Contractor[] @relation("ContractorLinkGenerator")

  notifications     Notification[]
  mustChangePassword Boolean  @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([role])
  @@index([supervisorId])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  message     String   @db.Text
  type        String   @default("SYSTEM") // SYSTEM, INVENTORY, CONTRACTOR, PROJECT, FINANCE
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  isRead      Boolean  @default(false)
  link        String?  // Deep link to the relevant page (e.g., /admin/inventory/requests)
  metadata    Json?    // Optional extra data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model RestoreRequest {
  id              String   @id @default(cuid())
  serviceOrderId  String
  serviceOrder    ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)
  requestedById   String
  requestedBy     User     @relation("RequestedRestores", fields: [requestedById], references: [id])
  reason          String   @db.Text
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedById    String?
  approvedBy      User?    @relation("ApprovedRestores", fields: [approvedById], references: [id])
  approvalComment String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([serviceOrderId])
  @@index([requestedById])
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // e.g., "CREATE", "UPDATE", "DELETE", "STATUS_CHANGE"
  entity      String   // e.g., "ServiceOrder", "InventoryItem"
  entityId    String
  oldValue    Json?
  newValue    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
}

model Staff {
  id          String   @id @default(cuid())
  name        String
  employeeId  String   @unique
  designation Role
  area        String?
  opmcId      String?
  opmc        OPMC?    @relation(fields: [opmcId], references: [id]) // Home OPMC
  reportsToId String?
  reportsTo   Staff?   @relation("Hierarchy", fields: [reportsToId], references: [id])
  subordinates Staff[] @relation("Hierarchy")
  projects     Project[]
  user        User?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([opmcId])
  @@index([reportsToId])
  @@index([designation])
}

model Project {
  id            String   @id @default(cuid())
  projectCode   String   @unique // e.g., "PRJ-2026-001"
  name          String
  description   String?  @db.Text
  type          String   @default("FTTH") // FTTH, FAC, BUILDING, OTHER
  location      String?  @db.Text
  
  // Status & Progress
  status        String   @default("PLANNING") // PLANNING, APPROVED, IN_PROGRESS, ON_HOLD, COMPLETED, CANCELLED
  progress      Float    @default(0) // 0-100%
  
  // Budget & Cost
  budget        Float?   // Total approved budget
  actualCost    Float    @default(0) // Running actual cost
  variance      Float?   // Budget variance (calculated)
  
  // Timeline
  startDate     DateTime?
  endDate       DateTime?
  estimatedDuration Int? // in days
  actualDuration    Int? // in days
  
  // Team
  areaManagerId String?
  areaManager   Staff?   @relation(fields: [areaManagerId], references: [id])
  contractorId  String?
  contractor    Contractor? @relation(fields: [contractorId], references: [id])
  
  // Location
  opmcId        String?
  opmc          OPMC?    @relation(fields: [opmcId], references: [id])
  
  // Relations
  boqItems      ProjectBOQItem[] // Bill of Quantities
  milestones    ProjectMilestone[]
  expenses      ProjectExpense[]
  sods          SOD[]
  invoices      Invoice[]
  stockIssues   StockIssue[]
  projectReturns ProjectMaterialReturn[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([status])
  @@index([opmcId])
  @@index([contractorId])
}

// BOQ (Bill of Quantities) Item
model ProjectBOQItem {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Item Details
  itemCode    String   // BOQ item code (e.g., "A.1.1")
  description String   @db.Text
  unit        String   // m, km, Nos, L, kg, etc.
  quantity    Float
  unitRate    Float    // Rate per unit
  amount      Float    // quantity * unitRate
  
  // Category
  category    String?  // CIVIL, ELECTRICAL, MATERIAL, LABOR
  
  // Actuals
  actualQuantity Float @default(0)
  actualCost     Float @default(0)
  
  // Material Linking
  materialId  String?
  material    InventoryItem? @relation("BOQMaterials", fields: [materialId], references: [id])
  
  remarks     String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([category])
}

// Project Milestones
model ProjectMilestone {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  name        String
  description String?  @db.Text
  targetDate  DateTime
  completedDate DateTime?
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, DELAYED
  progress    Float    @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([status])
}

// Project Expenses (Non-BOQ costs)
model ProjectExpense {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  type        String   // MATERIAL, LABOR, EQUIPMENT, TRANSPORT, MISC
  description String   @db.Text
  amount      Float
  date        DateTime @default(now())
  
  invoiceRef  String?  // Reference to invoice/receipt
  remarks     String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([type])
  @@index([date])
}

model Material {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  unit        String
  quantity    Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  sodItems    SODItem[]
}

model SOD {
  id          String   @id @default(cuid())
  sodNumber   String   @unique
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  status      String   @default("PENDING")
  rtom        String?
  items       SODItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SODItem {
  id          String   @id @default(cuid())
  sodId       String
  sod         SOD      @relation(fields: [sodId], references: [id])
  materialId  String
  material    Material @relation(fields: [materialId], references: [id])
  quantity    Float
  used        Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum ContractorStatus {
  ACTIVE
  INACTIVE
  PENDING         // Link generated, waiting for contractor to fill
  ARM_PENDING     // Form completed by contractor, waiting for ARM
  OSP_PENDING     // ARM approved, waiting for OSP Manager
  REJECTED
}

enum ContractorType {
  SOD
  OSP
}

model Contractor {
  id                    String            @id @default(cuid())
  name                  String
  contactNumber         String?
  email                 String?
  nic                   String?
  address               String?
  type                  ContractorType    @default(SOD)
  registrationNumber    String?           @unique
  brNumber              String?
  status                ContractorStatus  @default(PENDING)

  // Documents
  photoUrl              String?
  nicFrontUrl           String?
  nicBackUrl            String?
  policeReportUrl       String?
  gramaCertUrl          String?

  registrationFeePaid   Boolean           @default(false)
  agreementSigned       Boolean           @default(false)
  agreementDate         DateTime?
  agreementDuration     Int?              @default(1) // 1, 2, 3 years
  brCertUrl             String?
  
  // Workflow & Approval
  armApprovedAt         DateTime?
  armApprovedById       String?
  armApprovedBy         User?             @relation("ContractorArmApproval", fields: [armApprovedById], references: [id])
  
  ospApprovedAt         DateTime?
  ospApprovedById       String?
  ospApprovedBy         User?             @relation("ContractorOspApproval", fields: [ospApprovedById], references: [id])
  
  rejectionReason       String?           // Reason provided if registration is rejected
  rejectionById         String?
  rejectionBy           User?             @relation("ContractorRejection", fields: [rejectionById], references: [id])
  rejectedAt            DateTime?
  
  registrationToken     String?           @unique
  registrationTokenExpiry DateTime?
  registrationStartedAt DateTime?
  registrationDraft   Json?             // To save partial form data (Step persistence)
  siteOfficeStaffId     String?           // Who generated the link
  siteOfficeStaff       User?             @relation("ContractorLinkGenerator", fields: [siteOfficeStaffId], references: [id])
  
  opmcId                String?
  opmc                  OPMC?             @relation(fields: [opmcId], references: [id])
  
  // Bank Details
  bankName              String?
  bankBranch            String?
  bankAccountNumber     String?
  bankPassbookUrl       String?

  // Review & External Links
  documentStatus        String            @default("PENDING") // PENDING, APPROVED, REJECTED
  uploadToken           String?           @unique
  uploadTokenExpiry     DateTime?
  
  

  
  serviceOrders         ServiceOrder[]
  teamMembers           TeamMember[] // Direct members (legacy or pool)
  teams                 ContractorTeam[] // Structured teams
  invoices              Invoice[]
  projects              Project[] // Projects assigned to contractor
  
  // Material Management
  materialIssues        ContractorMaterialIssue[] @relation("MaterialIssues")
  materialReturns       ContractorMaterialReturn[] @relation("MaterialReturns")
  wastageReports        ContractorWastage[]
  balanceSheets         ContractorMaterialBalanceSheet[] @relation("BalanceSheets")
  
  // Real-time Stock
  stock                 ContractorStock[]
  stockIssues           StockIssue[] @relation("ContractorIssues")

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([status])
  @@index([opmcId])
  @@index([type])
}

model ContractorStock {
  id            String         @id @default(cuid())
  contractorId  String
  contractor    Contractor     @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  itemId        String
  item          InventoryItem  @relation(fields: [itemId], references: [id])
  quantity      Float          @default(0) // Current In-hand Quantity
  updatedAt     DateTime       @updatedAt

  @@unique([contractorId, itemId])
  @@index([contractorId])
  @@index([itemId])
}

model ContractorTeam {
  id           String   @id @default(cuid())
  name         String
  status       String   @default("ACTIVE") // ACTIVE, INACTIVE
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  // Multiple stores assignment (team can work in multiple stores)
  storeAssignments TeamStoreAssignment[]
  
  // Primary OPMC (optional, for reference)
  opmcId       String?
  opmc         OPMC?    @relation(fields: [opmcId], references: [id])
  
  serviceOrders ServiceOrder[]
  
  members      TeamMember[]
  sltCode      String?  // SLT Identification code provided after OSP approval
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Junction table for Team-Store many-to-many relationship
model TeamStoreAssignment {
  id        String   @id @default(cuid())
  teamId    String
  team      ContractorTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  storeId   String
  store     InventoryStore @relation(fields: [storeId], references: [id], onDelete: Cascade)
  isPrimary Boolean  @default(false) // Mark primary store
  createdAt DateTime @default(now())
  
  @@unique([teamId, storeId])
  @@index([teamId])
  @@index([storeId])
}

model TeamMember {
  id                    String      @id @default(cuid())
  name                  String
  idCopyNumber          String?
  contractorIdCopyNumber String?
  nic                   String?
  designation           String?
  
  // Documents
  photoUrl              String?
  nicUrl                String?
  policeReportUrl       String?
  gramaCertUrl          String?
  
  contactNumber         String?
  address               String?
  
  // New Fields
  shoeSize              String?
  tshirtSize            String?
  passportPhotoUrl      String? // For Office ID

  // Public Upload Fields
  uploadToken           String?   @unique
  uploadTokenExpiry     DateTime?
  
  contractorId          String
  contractor            Contractor  @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  teamId                String?
  team                  ContractorTeam? @relation(fields: [teamId], references: [id], onDelete: SetNull)

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
}


model Invoice {
  id             String     @id @default(cuid())
  invoiceNumber  String     @unique
  contractorId   String
  contractor     Contractor @relation(fields: [contractorId], references: [id])
  projectId      String?
  project        Project?   @relation(fields: [projectId], references: [id])
  amount         Float
  status         String     @default("PENDING") // PENDING, APPROVED, PAID
  description    String?    @db.Text
  dueDate        DateTime?
  date           DateTime   @default(now())
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model Vehicle {
  id              String   @id @default(cuid())
  registration    String   @unique
  make            String?
  model           String?
  status          String   @default("ACTIVE")
  licenseExpiry   DateTime
  licensePhotoUrl String?
  driverName      String?
  ownerType       String   @default("HIRED") // OWNED, HIRED
  rentAmount      Float?
  fuelLimit       Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Table Column Settings
model TableColumnSettings {
  id          String   @id @default(cuid())
  tableName   String   @unique // pending_sod, completed_sod, return_sod, restore_request
  columns     String   @db.Text // JSON array of visible column names
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- INVENTORY MODULE ---

model InventoryStore {
  id          String   @id @default(cuid())
  name        String   
  type        String   @default("SUB") // MAIN, SUB
  location    String?
  managerId   String?  
  manager     User?    @relation(fields: [managerId], references: [id])
  assignedUsers User[] @relation("UserAssignedStore")
  stocks      InventoryStock[]
  outRequests StockRequest[] @relation("RequestSource") // Requests FROM this store (Sub Stores)
  inRequests  StockRequest[] @relation("RequestTarget") // Requests TO this store (Main Store)
  grns        GRN[]
  mrns        MRN[]
  transactions InventoryTransaction[]

  opmcs       OPMC[]
  teamAssignments TeamStoreAssignment[] // Teams assigned to this store
  
  // Material Management
  materialIssues  ContractorMaterialIssue[] @relation("MaterialIssues")
  materialReturns ContractorMaterialReturn[] @relation("MaterialReturns")
  projectReturns  ProjectMaterialReturn[]
  wastageReports  ContractorWastage[]
  balanceSheets   ContractorMaterialBalanceSheet[] @relation("BalanceSheets")
  stockIssues     StockIssue[] @relation("StockIssues")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([managerId])
}

model InventoryItem {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  unit        String   // Nos, kg, L, m, pkts
  type        String   @default("SLTS") // SLT, SLTS
  category    String   @default("OTHERS") // OSP_NEW_CONN, OSP_PROJECT, OTHERS
  minLevel    Float    @default(0) // Global low stock alert threshold
  isWastageAllowed Boolean @default(true)
  maxWastagePercentage Float @default(0)
  stocks      InventoryStock[]
  requestItems StockRequestItem[]
  grnItems    GRNItem[]
  transactionItems InventoryTransactionItem[]
  
  // Material Management
  materialStandards MaterialStandard[] @relation("MaterialStandards")
  issueItems        ContractorMaterialIssueItem[] @relation("IssueItems")
  sodUsage          SODMaterialUsage[] @relation("SODUsage")
  returnItems       ContractorMaterialReturnItem[] @relation("ReturnItems")
  wastageItems      ContractorWastageItem[] 
  balanceSheetItems ContractorBalanceSheetItem[] @relation("BalanceSheetItems")
  mrnItems          MRNItem[]
  contractorStock   ContractorStock[]
  stockIssueItems   StockIssueItem[] @relation("IssueItemsStock")
  projectReturnItems ProjectMaterialReturnItem[] @relation("ProjectReturnItems")
  boqItems          ProjectBOQItem[] @relation("BOQMaterials")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // New Fields
  source      String   @default("SLT") // SLT, PRIVATE
  commonFor   String[] // Array of types: ["FTTH", "PSTN", "OSP"] to hint usage
  
  // New Fields for OSP Management
  commonName  String?  // Grouping name (e.g. "FAC", "Drop Wire")
  isOspFtth   Boolean? @default(false) // Filter for OSP FTTH context

  @@index([code])
  @@index([type])
  @@index([category])
  @@index([commonName])
}

model InventoryStock {
  id        String        @id @default(cuid())
  storeId   String
  store     InventoryStore @relation(fields: [storeId], references: [id])
  itemId    String
  item      InventoryItem  @relation(fields: [itemId], references: [id])
  quantity  Float         @default(0)
  minLevel  Float         @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([storeId, itemId])
}

model StockRequest {
  id          String   @id @default(cuid())
  requestNr   String   @unique @default(cuid()) 
  fromStoreId String?
  fromStore   InventoryStore? @relation("RequestSource", fields: [fromStoreId], references: [id])
  toStoreId   String?   
  toStore     InventoryStore? @relation("RequestTarget", fields: [toStoreId], references: [id])
  status      String   @default("PENDING") 
  requestedById String
  requestedBy User     @relation("RequestUser", fields: [requestedById], references: [id])
  approvedById String?
  approvedBy  User?    @relation("ApproveUser", fields: [approvedById], references: [id])
  remarks     String?  @db.Text // OSP Manager remarks during approval/rejection
  sltReferenceId String? // SLT delivery note/report ID
  
  // New ERP Features
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  requiredDate DateTime?
  purpose     String?  @db.Text

  // Procurement & Workflow
  sourceType    String   @default("SLT") // SLT, LOCAL_PURCHASE, MAIN_STORE
  projectTypes  String[] // OSP_FTTH, OSP_PSTN, ...
  maintenanceMonths String? // 1M, 2M, 3M
  
  workflowStage String   @default("REQUEST") // REQUEST, ARM_APPROVAL, STORES_MANAGER_APPROVAL, OSP_MANAGER_APPROVAL, PROCUREMENT, MAIN_STORE_RELEASE, SUB_STORE_RECEIVE, GRN_PENDING, COMPLETED, REJECTED, RETURNED
  procurementStatus String @default("PENDING") // PENDING, PO_CREATED, PO_SENT, PO_CONFIRMED, COMPLETED
  
  // Purchase Order Details
  poNumber        String?   // Purchase Order Number
  vendor          String?   // Vendor/Supplier Name
  expectedDelivery DateTime? // Expected Delivery Date
  irNumber        String?   // Issue Receipt Number (for SLT Head Office requests)
  isCoveringPO    Boolean   @default(false) // True if PO created after receiving goods (SLT workflow)
  
  // 3-Tier Approval System (Sub Stores Only)
  // Layer 1: ARM (Area Manager) Approval
  armAction          String?
  armDate            DateTime?
  armRemarks         String?  @db.Text
  armApprovedById    String?
  armApprovedBy      User?    @relation("ARMApprover", fields: [armApprovedById], references: [id])
  
  // Layer 2: Stores Manager Approval
  storesManagerAction   String?
  storesManagerDate     DateTime?
  storesManagerRemarks  String?  @db.Text
  storesManagerApprovedById String?
  storesManagerApprovedBy   User? @relation("StoresManagerApprover", fields: [storesManagerApprovedById], references: [id])
  
  // Layer 3: OSP Manager Approval (existing fields)
  hsOspAction   String? 
  hsOspDate     DateTime?
  managerAction String? 
  managerDate   DateTime?
  
  // Release/Receive Tracking (Main Store Distribution)
  releasedById       String?
  releasedDate       DateTime?
  releasedBy         User?    @relation("ReleasedBy", fields: [releasedById], references: [id])
  releasedRemarks    String?  @db.Text
  
  receivedById       String?
  receivedDate       DateTime?
  receivedBy         User?    @relation("ReceivedBy", fields: [receivedById], references: [id])
  receivedRemarks    String?  @db.Text
  
  items       StockRequestItem[]
  grns        GRN[]    // Support Multiple GRNs for Partial Delivery
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([fromStoreId])
  @@index([toStoreId])
  @@index([requestedById])
  @@index([status])
  @@index([workflowStage])
  @@index([createdAt])
}

model StockRequestItem {
  id          String       @id @default(cuid())
  requestId   String
  request     StockRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  itemId      String
  item        InventoryItem @relation(fields: [itemId], references: [id])
  requestedQty Float
  approvedQty  Float        @default(0)  // OSP Manager approved quantity
  issuedQty    Float?                    // Main Store Assistant released quantity
  receivedQty  Float        @default(0)  // Sub Store Officer confirmed quantity
  remarks      String?      
  make         String?
  model        String?
  suggestedVendor String?
  createdAt   DateTime     @default(now())

  @@index([requestId])
  @@index([itemId])
}

model GRN {
  id          String   @id @default(cuid())
  grnNumber   String   @unique
  storeId     String   
  store       InventoryStore @relation(fields: [storeId], references: [id])
  sourceType  String   // SLT, LOCAL_PURCHASE
  supplier    String?  
  requestId   String?  // Removed @unique to allow multiple GRNs per request
  request     StockRequest? @relation(fields: [requestId], references: [id])
  receivedById String
  receivedBy  User     @relation(fields: [receivedById], references: [id])
  
  reference   String?  // External Invoice / Delivery Note / SLT Ref Number
  
  items       GRNItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([storeId])
  @@index([requestId])
  @@index([grnNumber])
}

model GRNItem {
  id        String   @id @default(cuid())
  grnId     String
  grn       GRN      @relation(fields: [grnId], references: [id], onDelete: Cascade)
  itemId    String
  item      InventoryItem @relation(fields: [itemId], references: [id])
  quantity  Float
  createdAt DateTime @default(now())

  @@index([grnId])
  @@index([itemId])
}

model MRN {
  id          String   @id @default(cuid())
  mrnNumber   String   @unique
  storeId     String   
  store       InventoryStore @relation(fields: [storeId], references: [id])
  returnType  String   // DEFECTIVE, EXCESS, UNUSED, WRONG_DELIVERY
  returnTo    String?  // SLT, SUPPLIER, MAIN_STORE
  supplier    String?  
  reason      String?  @db.Text
  grnId       String?  // Link to original GRN if returning from a GRN
  returnedById String
  returnedBy  User     @relation(fields: [returnedById], references: [id])
  status      String   @default("PENDING") // PENDING, APPROVED, COMPLETED
  approvedById String?
  approvedBy  User?    @relation("MRNApprover", fields: [approvedById], references: [id])
  items       MRNItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([storeId])
  @@index([status])
  @@index([mrnNumber])
}

model MRNItem {
  id        String   @id @default(cuid())
  mrnId     String
  mrn       MRN      @relation(fields: [mrnId], references: [id], onDelete: Cascade)
  itemId    String
  item      InventoryItem @relation(fields: [itemId], references: [id])
  quantity  Float
  reason    String?  @db.Text // Item-specific reason
  createdAt DateTime @default(now())

  @@index([mrnId])
  @@index([itemId])
}

model InventoryTransaction {
  id          String   @id @default(cuid())
  type        String   // GRN_IN, TRANSFER_IN, TRANSFER_OUT, WASTAGE, RETURN
  storeId     String
  store       InventoryStore @relation(fields: [storeId], references: [id])
  referenceId String?  
  notes       String?
  date        DateTime @default(now())
  userId      String
  items       InventoryTransactionItem[]

  @@index([storeId])
  @@index([type])
  @@index([date])
}

model InventoryTransactionItem {
  id            String   @id @default(cuid())
  transactionId String
  transaction   InventoryTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  itemId        String
  item          InventoryItem @relation(fields: [itemId], references: [id])
  quantity      Float    
}
// Material Categories (OSP New Connection, FAC, etc.)
model MaterialCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  standards   MaterialStandard[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Standard materials per package type
model MaterialStandard {
  id              String   @id @default(cuid())
  categoryId      String
  category        MaterialCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  packageType     String   // "VOICE_INT", "VOICE_IPTV", etc.
  itemId          String
  item            InventoryItem @relation("MaterialStandards", fields: [itemId], references: [id])
  
  standardQty     Float    // Standard quantity per SOD
  maxQty          Float?   // Maximum allowed
  wastagePercent  Float    @default(5) // Max wastage %
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([categoryId, packageType, itemId])
  @@index([packageType])
}

// Material issued to contractor (per store)
model ContractorMaterialIssue {
  id              String   @id @default(cuid())
  contractorId    String
  contractor      Contractor @relation("MaterialIssues", fields: [contractorId], references: [id], onDelete: Cascade)
  storeId         String
  store           InventoryStore @relation("MaterialIssues", fields: [storeId], references: [id])
  
  issueDate       DateTime @default(now())
  month           String   // "2025-01"
  issuedBy        String?  // User ID
  
  items           ContractorMaterialIssueItem[]
  
  createdAt       DateTime @default(now())
  
  @@index([contractorId, storeId, month])
  @@index([month])
}

model ContractorMaterialIssueItem {
  id              String   @id @default(cuid())
  issueId         String
  issue           ContractorMaterialIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  itemId          String
  item            InventoryItem @relation("IssueItems", fields: [itemId], references: [id])
  
  quantity        Float
  unit            String
  
  @@index([issueId])
  @@index([itemId])
}

// Material used per SOD
model SODMaterialUsage {
  id              String   @id @default(cuid())
  serviceOrderId  String
  serviceOrder    ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)
  
  itemId          String
  item            InventoryItem @relation("SODUsage", fields: [itemId], references: [id])
  
  quantity        Float
  unit            String
  usageType       String   // "USED", "WASTAGE"
  
  // Wastage tracking
  wastagePercent  Float?   // Calculated wastage %
  exceedsLimit    Boolean  @default(false) // If wastage > standard
  comment         String?  @db.Text // Required if exceeds limit
  serialNumber    String?  // For items that require serial tracking (ONT, STB, Splice, etc)
  approvedBy      String?  // Store Manager approval
  approvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([serviceOrderId])
  @@index([itemId])
  @@index([usageType])
}

// Material returns
model ContractorMaterialReturn {
  id              String   @id @default(cuid())
  contractorId    String
  contractor      Contractor @relation("MaterialReturns", fields: [contractorId], references: [id], onDelete: Cascade)
  storeId         String
  store           InventoryStore @relation("MaterialReturns", fields: [storeId], references: [id])
  
  returnDate      DateTime @default(now())
  month           String   // Month being returned for
  reason          String?  @db.Text
  
  items           ContractorMaterialReturnItem[]
  
  acceptedBy      String?  // Store Manager
  acceptedAt      DateTime?
  status          String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  
  createdAt       DateTime @default(now())
  
  @@index([contractorId, storeId, month])
  @@index([status])
}

model ContractorMaterialReturnItem {
  id              String   @id @default(cuid())
  returnId        String
  return          ContractorMaterialReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  
  itemId          String
  item            InventoryItem @relation("ReturnItems", fields: [itemId], references: [id])
  
  quantity        Float
  unit            String
  condition       String   @default("GOOD") // GOOD, DAMAGED
  
  @@index([returnId])
  @@index([itemId])
}

// Standalone Wastage (Lost/Damaged by Contractor)
model ContractorWastage {
  id              String   @id @default(cuid())
  contractorId    String
  contractor      Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  storeId         String
  store           InventoryStore @relation(fields: [storeId], references: [id])
  
  date            DateTime @default(now())
  month           String   // Month of wastage
  description     String?  // Reason for wastage
  
  items           ContractorWastageItem[]
  
  createdAt       DateTime @default(now())
  
  @@index([contractorId, storeId, month])
}

model ContractorWastageItem {
  id              String   @id @default(cuid())
  wastageId       String
  wastage         ContractorWastage @relation(fields: [wastageId], references: [id], onDelete: Cascade)
  
  itemId          String
  item            InventoryItem @relation(fields: [itemId], references: [id])
  
  quantity        Float
  unit            String
  
  @@index([wastageId])
  @@index([itemId])
}

// Monthly balance sheet (per store)
model ContractorMaterialBalanceSheet {
  id              String   @id @default(cuid())
  contractorId    String
  contractor      Contractor @relation("BalanceSheets", fields: [contractorId], references: [id], onDelete: Cascade)
  storeId         String
  store           InventoryStore @relation("BalanceSheets", fields: [storeId], references: [id])
  
  month           String   // "2025-01"
  
  items           ContractorBalanceSheetItem[]
  
  totalValue      Float?
  usageRate       Float?   // Percentage
  wastageRate     Float?   // Percentage
  
  generatedAt     DateTime @default(now())
  generatedBy     String?  // User ID
  
  @@unique([contractorId, storeId, month])
  @@index([month])
  @@index([contractorId])
  @@index([storeId])
}

model ContractorBalanceSheetItem {
  id              String   @id @default(cuid())
  balanceSheetId  String
  balanceSheet    ContractorMaterialBalanceSheet @relation(fields: [balanceSheetId], references: [id], onDelete: Cascade)
  
  itemId          String
  item            InventoryItem @relation("BalanceSheetItems", fields: [itemId], references: [id])
  
  openingBalance  Float    // From previous month
  received        Float    // Issued this month
  returned        Float    @default(0) // Returned to store
  used            Float    // Used in SODs
  wastage         Float    // Wastage
  closingBalance  Float    // Opening + Received - Returned - Used - Wastage
  requiredNext    Float?   // Estimated for next month
  
  @@index([balanceSheetId])
  @@index([itemId])
}


// Stock Issue (Materials issued to projects/contractors/teams)
model StockIssue {
  id            String   @id @default(cuid())
  issueNumber   String   @unique
  storeId       String
  store         InventoryStore @relation("StockIssues", fields: [storeId], references: [id])
  issuedById    String
  issuedBy      User     @relation("StockIssuer", fields: [issuedById], references: [id])
  issueType     String   // PROJECT, CONTRACTOR, TEAM, OTHER
  projectId     String?
  project       Project? @relation(fields: [projectId], references: [id])
  contractorId  String?
  contractor    Contractor? @relation("ContractorIssues", fields: [contractorId], references: [id])
  teamId        String?
  recipientName String   // Person receiving the materials
  remarks       String?  @db.Text
  items         StockIssueItem[]
  
  // Approval Workflow
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedById  String?
  approvedBy    User?    @relation("IssueApprover", fields: [approvedById], references: [id])
  approvedAt    DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([storeId])
  @@index([issueType])
  @@index([status])
}

model StockIssueItem {
  id        String   @id @default(cuid())
  issueId   String
  issue     StockIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  itemId    String
  item      InventoryItem @relation("IssueItemsStock", fields: [itemId], references: [id])
  quantity  Float
  remarks   String?
  createdAt DateTime @default(now())
  
  @@index([issueId])
  @@index([itemId])
}

// Project Material Return (Project -> Store)
model ProjectMaterialReturn {
  id            String   @id @default(cuid())
  returnNumber  String   @unique
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id])
  storeId       String
  store         InventoryStore @relation(fields: [storeId], references: [id])
  returnedById  String
  returnedBy    User     @relation("ProjectReturnUser", fields: [returnedById], references: [id])
  
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedById  String?
  approvedBy    User?    @relation("ProjectReturnApprover", fields: [approvedById], references: [id])
  approvedAt    DateTime?
  
  reason        String?  @db.Text
  items         ProjectMaterialReturnItem[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([projectId])
  @@index([storeId])
  @@index([status])
}

model ProjectMaterialReturnItem {
  id        String   @id @default(cuid())
  returnId  String
  return    ProjectMaterialReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  itemId    String
  item      InventoryItem @relation("ProjectReturnItems", fields: [itemId], references: [id])
  quantity  Float
  condition String   @default("GOOD") // GOOD, DAMAGED
  remarks   String?
  
  @@index([returnId])
  @@index([itemId])
}

// Stock Movement Tracking
model StockMovement {
  id        String   @id @default(cuid())
  storeId   String
  itemId    String
  type      String   // IN, OUT, ADJUSTMENT
  quantity  Float
  reference String?  // GRN number, Issue number, etc.
  remarks   String?  @db.Text
  createdAt DateTime @default(now())
  
  @@index([storeId])
  @@index([itemId])
  @@index([type])
}

// Current Stock (replaces InventoryStock for clarity)
model CurrentStock {
  id        String   @id @default(cuid())
  storeId   String
  itemId    String
  quantity  Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([storeId, itemId])
  @@index([storeId])
  @@index([itemId])
}

// Section Management (Departments)
model Section {
  id          String   @id @default(cuid())
  name        String   @unique // "Projects", "New Connection", "Service Assurance", etc.
  code        String   @unique // "PROJECTS", "NEW_CONNECTION", "SERVICE_ASSURANCE"
  description String?  @db.Text
  icon        String?  // Icon name for UI
  color       String?  // Color code for UI
  isActive    Boolean  @default(true)
  
  // Relations
  roles       SystemRole[]
  userAssignments UserSectionAssignment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// System Roles (Job Posts per Section)
model SystemRole {
  id          String   @id @default(cuid())
  name        String   // "Project Engineer", "NC Manager", "SA Technician"
  code        String   @unique // "PROJECT_ENGINEER", "NC_MANAGER", "SA_TECHNICIAN"
  sectionId   String
  section     Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  description String?  @db.Text
  level       Int      @default(1) // 1=Junior, 2=Mid, 3=Senior, 4=Manager
  isActive    Boolean  @default(true)
  
  // Permissions (JSON array of allowed pages/actions)
  permissions String   @db.Text // JSON: ["service-orders", "contractors", etc.]
  
  // Relations
  userAssignments UserSectionAssignment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([sectionId])
}

// User Section Assignment (Many-to-Many with Role)
model UserSectionAssignment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sectionId String
  section   Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  roleId    String
  role      SystemRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  isPrimary Boolean  @default(false) // Primary section for user
  
  createdAt DateTime @default(now())
  
  @@unique([userId, sectionId])
  @@index([userId])
  @@index([sectionId])
  @@index([roleId])
}
model SystemConfig {
  key String @id
  value String
  description String?
  updatedAt DateTime @updatedAt
}

model Bank {
  id        String       @id @default(cuid())
  code      String       @unique
  name      String
  branches  BankBranch[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model BankBranch {
  id        String   @id @default(cuid())
  bankId    String
  bank      Bank     @relation(fields: [bankId], references: [id], onDelete: Cascade)
  code      String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([bankId, code])
}

// SOD Revenue Configuration
model SODRevenueConfig {
  id            String   @id @default(cuid())
  
  // RTOM (null = Default for all RTOMs)
  rtomId        String?
  rtom          OPMC?    @relation(fields: [rtomId], references: [id], onDelete: Cascade)
  
  // Revenue Amount
  revenuePerSOD Float    // Rs. 10,500, Rs. 12,555, etc.
  
  // Time Period (Optional - for circular-based changes)
  effectiveFrom DateTime? // null = Always active
  effectiveTo   DateTime? // null = No end date
  
  // Metadata
  circularRef   String?  // "Circular No. 2026/01"
  notes         String?  @db.Text
  isActive      Boolean  @default(true)
  
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([rtomId])
  @@index([effectiveFrom, effectiveTo])
  @@index([isActive])
}
