generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["metrics"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
}

model OPMC {
  id                       String                    @id @default(cuid())
  name                     String                    @default("")
  rtom                     String                    @unique
  region                   String                    @default("METRO")
  province                 String                    @default("METRO 01")
  storeId                  String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  contractors              Contractor[]
  contractorPaymentConfigs ContractorPaymentConfig[]
  contractorTeams          ContractorTeam[]
  store                    InventoryStore?           @relation(fields: [storeId], references: [id])
  projects                 Project[]
  revenueConfigs           SODRevenueConfig[]
  serviceOrders            ServiceOrder[]
  staff                    Staff[]
  users                    User[]                    @relation("UserOpmcs")
}

model ServiceOrder {
  id                String             @id @default(cuid())
  rtom              String
  lea               String?
  soNum             String
  voiceNumber       String?
  orderType         String?
  serviceType       String?
  customerName      String?
  techContact       String?
  status            String
  statusDate        DateTime?
  receivedDate      DateTime?
  address           String?
  dp                String?
  package           String?
  ospPhoneClass     String?
  phonePurchase     String?
  sales             String?
  woroTaskName      String?
  iptv              String?
  woroSeit          String?
  ftthInstSeit      String?
  ftthWifi          String?
  sltsStatus        String             @default("INPROGRESS")
  scheduledDate     DateTime?
  scheduledTime     String?
  comments          String?
  completedDate     DateTime?
  ontSerialNumber   String?
  iptvSerialNumbers String?
  dpDetails         String?
  patStatus         String?
  sltsPatStatus     String?            @default("PENDING")
  sltsPatDate       DateTime?
  opmcPatStatus     String?            @default("PENDING")
  opmcPatDate       DateTime?
  hoPatStatus       String?            @default("PENDING")
  hoPatDate         DateTime?
  isInvoicable      Boolean            @default(false)
  invoiced          Boolean            @default(false)
  invoiceId         String?
  wiredOnly         Boolean            @default(false)
  delayReasons      Json?
  stbShortage       Boolean            @default(false)
  ontShortage       Boolean            @default(false)
  ontType           String?
  returnReason      String?
  completionMode    String?
  materialSource    String?
  directTeam        String?
  photoUrls         String[]           @default([])
  dropWireDistance  Float?
  revenueAmount     Float?
  contractorAmount  Float?
  opmcId            String
  contractorId      String?
  teamId            String?
  isManualEntry    Boolean            @default(false)
  isLegacyImport    Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  restoreRequests   RestoreRequest[]
  materialUsage     SODMaterialUsage[]
  statusHistory     ServiceOrderStatusHistory[]
  contractor        Contractor?        @relation(fields: [contractorId], references: [id])
  invoice           Invoice?           @relation(fields: [invoiceId], references: [id])
  opmc              OPMC               @relation(fields: [opmcId], references: [id], onDelete: Cascade)
  team              ContractorTeam?    @relation(fields: [teamId], references: [id])

  @@unique([soNum])
  @@index([opmcId])
  @@index([rtom])
  @@index([status])
  @@index([soNum])
  @@index([scheduledDate])
  @@index([contractorId])
  @@index([teamId])
  @@index([sltsStatus])
  @@index([createdAt])
  @@index([completedDate])
  @@index([updatedAt])
  @@index([opmcId, status])
  @@index([opmcId, sltsStatus])
  
  forensicAudit     SODForensicAudit?
}

model SODForensicAudit {
  id              String       @id @default(cuid())
  soNum           String       @unique
  serviceOrder    ServiceOrder @relation(fields: [soNum], references: [soNum], onDelete: Cascade)
  auditData       Json         // [{ name: string, status: string, uuid: string }]
  voiceTestStatus String?      // PASS/FAIL
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([soNum])
}


model ServiceOrderStatusHistory {
  id              String       @id @default(cuid())
  serviceOrderId  String
  serviceOrder    ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)
  status          String
  statusDate      DateTime
  createdAt       DateTime     @default(now())

  @@index([serviceOrderId])
  @@index([statusDate])
  @@index([status])
}

model User {
  id                            String                   @id @default(cuid())
  email                         String                   @unique
  username                      String                   @unique
  password                      String
  name                          String?
  role                          Role                     @default(ENGINEER)
  staffId                       String?                  @unique
  securityQuestion              String?
  securityAnswer                String?
  employeeId                    String?
  supervisorId                  String?
  assignedStoreId               String?
  mustChangePassword            Boolean                  @default(false)
  createdAt                     DateTime                 @default(now())
  updatedAt                     DateTime                 @updatedAt
  auditLogs                     AuditLog[]
  armApprovedContractors        Contractor[]             @relation("ContractorArmApproval")
  ospApprovedContractors        Contractor[]             @relation("ContractorOspApproval")
  rejectedContractors           Contractor[]             @relation("ContractorRejection")
  generatedContractorLinks      Contractor[]             @relation("ContractorLinkGenerator")
  receivedGRNs                  GRN[]
  managedStores                 InventoryStore[]
  approvedMRNs                  MRN[]                    @relation("MRNApprover")
  returnedMRNs                  MRN[]
  notifications                 Notification[]
  notificationPreferences       NotificationPreference[]
  approvedProjectReturns        ProjectMaterialReturn[]  @relation("ProjectReturnApprover")
  projectReturns                ProjectMaterialReturn[]  @relation("ProjectReturnUser")
  approvedRestores              RestoreRequest[]         @relation("ApprovedRestores")
  requestedRestores             RestoreRequest[]         @relation("RequestedRestores")
  approvedIssues                StockIssue[]             @relation("IssueApprover")
  stockIssues                   StockIssue[]             @relation("StockIssuer")
  approvedStock                 StockRequest[]           @relation("ApproveUser")
  armApprovedRequests           StockRequest[]           @relation("ARMApprover")
  receivedRequests              StockRequest[]           @relation("ReceivedBy")
  releasedRequests              StockRequest[]           @relation("ReleasedBy")
  requestedStock                StockRequest[]           @relation("RequestUser")
  storesManagerApprovedRequests StockRequest[]           @relation("StoresManagerApprover")
  assignedStore                 InventoryStore?          @relation("UserAssignedStore", fields: [assignedStoreId], references: [id])
  staff                         Staff?                   @relation(fields: [staffId], references: [id])
  supervisor                    User?                    @relation("UserSupervisor", fields: [supervisorId], references: [id])
  subordinates                  User[]                   @relation("UserSupervisor")
  sectionAssignments            UserSectionAssignment[]
  accessibleOpmcs               OPMC[]                   @relation("UserOpmcs")

  @@index([role])
  @@index([supervisorId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("SYSTEM")
  priority  String   @default("MEDIUM")
  isRead    Boolean  @default(false)
  link      String?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model RestoreRequest {
  id              String       @id @default(cuid())
  serviceOrderId  String
  requestedById   String
  reason          String
  status          String       @default("PENDING")
  approvedById    String?
  approvalComment String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  approvedBy      User?        @relation("ApprovedRestores", fields: [approvedById], references: [id])
  requestedBy     User         @relation("RequestedRestores", fields: [requestedById], references: [id])
  serviceOrder    ServiceOrder @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([serviceOrderId])
  @@index([requestedById])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String
  entityId  String
  oldValue  Json?
  newValue  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
}

model Staff {
  id           String    @id @default(cuid())
  name         String
  employeeId   String    @unique
  designation  Role
  area         String?
  opmcId       String?
  reportsToId  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  projects     Project[]
  opmc         OPMC?     @relation(fields: [opmcId], references: [id])
  reportsTo    Staff?    @relation("Hierarchy", fields: [reportsToId], references: [id])
  subordinates Staff[]   @relation("Hierarchy")
  user         User?

  @@index([opmcId])
  @@index([reportsToId])
  @@index([designation])
}

model Project {
  id                String                  @id @default(cuid())
  projectCode       String                  @unique
  name              String
  description       String?
  type              String                  @default("FTTH")
  location          String?
  status            String                  @default("PLANNING")
  progress          Float                   @default(0)
  budget            Float?
  actualCost        Float                   @default(0)
  variance          Float?
  startDate         DateTime?
  endDate           DateTime?
  estimatedDuration Int?
  actualDuration    Int?
  areaManagerId     String?
  contractorId      String?
  opmcId            String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  invoices          Invoice[]
  areaManager       Staff?                  @relation(fields: [areaManagerId], references: [id])
  contractor        Contractor?             @relation(fields: [contractorId], references: [id])
  opmc              OPMC?                   @relation(fields: [opmcId], references: [id])
  boqItems          ProjectBOQItem[]
  expenses          ProjectExpense[]
  projectReturns    ProjectMaterialReturn[]
  milestones        ProjectMilestone[]
  sods              ProjectSOD[]
  stockIssues       StockIssue[]

  @@index([status])
  @@index([opmcId])
  @@index([contractorId])
}

model ProjectBOQItem {
  id             String         @id @default(cuid())
  projectId      String
  itemCode       String
  description    String
  unit           String
  quantity       Float
  unitRate       Float
  amount         Float
  category       String?
  actualQuantity Float          @default(0)
  actualCost     Float          @default(0)
  materialId     String?
  remarks        String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  material       InventoryItem? @relation("BOQMaterials", fields: [materialId], references: [id])
  project        Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([category])
}

model ProjectMilestone {
  id            String    @id @default(cuid())
  projectId     String
  name          String
  description   String?
  targetDate    DateTime
  completedDate DateTime?
  status        String    @default("PENDING")
  progress      Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
}

model ProjectExpense {
  id          String   @id @default(cuid())
  projectId   String
  type        String
  description String
  amount      Float
  date        DateTime @default(now())
  invoiceRef  String?
  remarks     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
  @@index([date])
}

model Material {
  id        String           @id @default(cuid())
  code      String           @unique
  name      String
  unit      String
  quantity  Float            @default(0)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  sodItems  ProjectSODItem[]
}

model ProjectSOD {
  id        String         @id @default(cuid())
  sodNumber String         @unique
  projectId String
  status    String         @default("PENDING")
  rtom      String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  project   Project        @relation(fields: [projectId], references: [id])
  items     ProjectSODItem[]
}

model ProjectSODItem {
  id         String      @id @default(cuid())
  sodId      String
  materialId String
  quantity   Float
  used       Float       @default(0)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  material   Material    @relation(fields: [materialId], references: [id])
  sod        ProjectSOD  @relation(fields: [sodId], references: [id])
}

model Contractor {
  id                      String                           @id @default(cuid())
  name                    String
  contactNumber           String?
  email                   String?
  nic                     String?
  address                 String?
  type                    ContractorType                   @default(SOD)
  registrationNumber      String?                          @unique
  brNumber                String?
  status                  ContractorStatus                 @default(PENDING)
  photoUrl                String?
  nicFrontUrl             String?
  nicBackUrl              String?
  policeReportUrl         String?
  gramaCertUrl            String?
  registrationFeePaid     Boolean                          @default(false)
  agreementSigned         Boolean                          @default(false)
  agreementDate           DateTime?
  agreementDuration       Int?                             @default(1)
  brCertUrl               String?
  armApprovedAt           DateTime?
  armApprovedById         String?
  ospApprovedAt           DateTime?
  ospApprovedById         String?
  rejectionReason         String?
  rejectionById           String?
  rejectedAt              DateTime?
  registrationToken       String?                          @unique
  registrationTokenExpiry DateTime?
  registrationStartedAt   DateTime?
  registrationDraft       Json?
  siteOfficeStaffId       String?
  opmcId                  String?
  bankName                String?
  bankBranch              String?
  bankAccountNumber       String?
  bankPassbookUrl         String?
  documentStatus          String                           @default("PENDING")
  uploadToken             String?                          @unique
  uploadTokenExpiry       DateTime?
  createdAt               DateTime                         @default(now())
  updatedAt               DateTime                         @updatedAt
  armApprovedBy           User?                            @relation("ContractorArmApproval", fields: [armApprovedById], references: [id])
  opmc                    OPMC?                            @relation(fields: [opmcId], references: [id])
  ospApprovedBy           User?                            @relation("ContractorOspApproval", fields: [ospApprovedById], references: [id])
  rejectionBy             User?                            @relation("ContractorRejection", fields: [rejectionById], references: [id])
  siteOfficeStaff         User?                            @relation("ContractorLinkGenerator", fields: [siteOfficeStaffId], references: [id])
  batchStocks             ContractorBatchStock[]
  balanceSheets           ContractorMaterialBalanceSheet[] @relation("BalanceSheets")
  materialIssues          ContractorMaterialIssue[]        @relation("MaterialIssues")
  materialReturns         ContractorMaterialReturn[]       @relation("MaterialReturns")
  stock                   ContractorStock[]
  teams                   ContractorTeam[]
  wastageReports          ContractorWastage[]
  invoices                Invoice[]
  projects                Project[]
  serviceOrders           ServiceOrder[]
  stockIssues             StockIssue[]                     @relation("ContractorIssues")
  teamMembers             TeamMember[]

  @@index([status])
  @@index([opmcId])
  @@index([type])
}

model ContractorStock {
  id           String        @id @default(cuid())
  contractorId String
  itemId       String
  quantity     Float         @default(0)
  updatedAt    DateTime      @updatedAt
  contractor   Contractor    @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  item         InventoryItem @relation(fields: [itemId], references: [id])

  @@unique([contractorId, itemId])
  @@index([contractorId])
  @@index([itemId])
}

model ContractorTeam {
  id               String                @id @default(cuid())
  name             String
  status           String                @default("ACTIVE")
  contractorId     String
  opmcId           String?
  sltCode          String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  contractor       Contractor            @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  opmc             OPMC?                 @relation(fields: [opmcId], references: [id])
  serviceOrders    ServiceOrder[]
  members          TeamMember[]
  storeAssignments TeamStoreAssignment[]
}

model TeamStoreAssignment {
  id        String         @id @default(cuid())
  teamId    String
  storeId   String
  isPrimary Boolean        @default(false)
  createdAt DateTime       @default(now())
  store     InventoryStore @relation(fields: [storeId], references: [id], onDelete: Cascade)
  team      ContractorTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, storeId])
  @@index([teamId])
  @@index([storeId])
}

model TeamMember {
  id                     String          @id @default(cuid())
  name                   String
  idCopyNumber           String?
  contractorIdCopyNumber String?
  nic                    String?
  designation            String?
  photoUrl               String?
  nicUrl                 String?
  policeReportUrl        String?
  gramaCertUrl           String?
  contactNumber          String?
  address                String?
  shoeSize               String?
  tshirtSize             String?
  passportPhotoUrl       String?
  uploadToken            String?         @unique
  uploadTokenExpiry      DateTime?
  contractorId           String
  teamId                 String?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  contractor             Contractor      @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  team                   ContractorTeam? @relation(fields: [teamId], references: [id])
}

model Invoice {
  id            String         @id @default(cuid())
  invoiceNumber String         @unique
  contractorId  String
  projectId     String?
  year          Int?
  month         Int?
  totalAmount   Float          @default(0)
  amountA       Float          @default(0)
  statusA       String         @default("PENDING")
  paidDateA     DateTime?
  amountB       Float          @default(0)
  statusB       String         @default("HOLD")
  paidDateB     DateTime?
  amount        Float
  status        String         @default("PENDING")
  description   String?
  dueDate       DateTime?
  date          DateTime       @default(now())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  contractor    Contractor     @relation(fields: [contractorId], references: [id])
  project       Project?       @relation(fields: [projectId], references: [id])
  sods          ServiceOrder[]
}

model Vehicle {
  id              String   @id @default(cuid())
  registration    String   @unique
  make            String?
  model           String?
  status          String   @default("ACTIVE")
  licenseExpiry   DateTime
  licensePhotoUrl String?
  driverName      String?
  ownerType       String   @default("HIRED")
  rentAmount      Float?
  fuelLimit       Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model TableColumnSettings {
  id        String   @id @default(cuid())
  tableName String   @unique
  columns   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InventoryStore {
  id              String                           @id @default(cuid())
  name            String
  type            String                           @default("SUB")
  location        String?
  managerId       String?
  createdAt       DateTime                         @default(now())
  updatedAt       DateTime                         @updatedAt
  balanceSheets   ContractorMaterialBalanceSheet[] @relation("BalanceSheets")
  materialIssues  ContractorMaterialIssue[]        @relation("MaterialIssues")
  materialReturns ContractorMaterialReturn[]       @relation("MaterialReturns")
  wastageReports  ContractorWastage[]
  grns            GRN[]
  batchStocks     InventoryBatchStock[]
  stocks          InventoryStock[]
  manager         User?                            @relation(fields: [managerId], references: [id])
  transactions    InventoryTransaction[]
  mrns            MRN[]
  opmcs           OPMC[]
  projectReturns  ProjectMaterialReturn[]
  stockIssues     StockIssue[]                     @relation("StockIssues")
  outRequests     StockRequest[]                   @relation("RequestSource")
  inRequests      StockRequest[]                   @relation("RequestTarget")
  teamAssignments TeamStoreAssignment[]
  assignedUsers   User[]                           @relation("UserAssignedStore")

  @@index([type])
  @@index([managerId])
}

model InventoryItem {
  id                    String                         @id @default(cuid())
  code                  String                         @unique
  name                  String
  description           String?
  unit                  String
  type                  String                         @default("SLTS")
  category              String                         @default("OTHERS")
  minLevel              Float                          @default(0)
  isWastageAllowed      Boolean                        @default(true)
  maxWastagePercentage  Float                          @default(0)
  createdAt             DateTime                       @default(now())
  updatedAt             DateTime                       @updatedAt
  source                String                         @default("SLT")
  commonFor             String[]
  unitPrice             Float?                         @default(0)
  costPrice             Float?                         @default(0)
  commonName            String?
  isOspFtth             Boolean?                       @default(false)
  importAliases         String[]
  balanceSheetItems     ContractorBalanceSheetItem[]   @relation("BalanceSheetItems")
  contractorBatchStocks ContractorBatchStock[]
  issueItems            ContractorMaterialIssueItem[]  @relation("IssueItems")
  returnItems           ContractorMaterialReturnItem[] @relation("ReturnItems")
  contractorStock       ContractorStock[]
  wastageItems          ContractorWastageItem[]
  grnItems              GRNItem[]
  batches               InventoryBatch[]
  batchStocks           InventoryBatchStock[]
  stocks                InventoryStock[]
  transactionItems      InventoryTransactionItem[]
  mrnItems              MRNItem[]
  materialStandards     MaterialStandard[]             @relation("MaterialStandards")
  boqItems              ProjectBOQItem[]               @relation("BOQMaterials")
  projectReturnItems    ProjectMaterialReturnItem[]    @relation("ProjectReturnItems")
  sodUsage              SODMaterialUsage[]             @relation("SODUsage")
  stockIssueItems       StockIssueItem[]               @relation("IssueItemsStock")
  requestItems          StockRequestItem[]

  @@index([code])
  @@index([type])
  @@index([category])
  @@index([commonName])
}

model InventoryStock {
  id        String         @id @default(cuid())
  storeId   String
  itemId    String
  quantity  Float          @default(0)
  minLevel  Float          @default(0)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  item      InventoryItem  @relation(fields: [itemId], references: [id])
  store     InventoryStore @relation(fields: [storeId], references: [id])

  @@unique([storeId, itemId])
}

model InventoryBatch {
  id               String                     @id @default(cuid())
  batchNumber      String?
  itemId           String
  grnId            String?
  initialQty       Float
  costPrice        Float                      @default(0)
  unitPrice        Float                      @default(0)
  createdAt        DateTime                   @default(now())
  contractorStocks ContractorBatchStock[]
  grnItem          GRNItem?
  grn              GRN?                       @relation(fields: [grnId], references: [id])
  item             InventoryItem              @relation(fields: [itemId], references: [id])
  storeStocks      InventoryBatchStock[]
  transactionItems InventoryTransactionItem[]
  usageItems       SODMaterialUsage[]

  @@index([itemId])
  @@index([createdAt])
}

model InventoryBatchStock {
  id        String         @id @default(cuid())
  storeId   String
  itemId    String
  batchId   String
  quantity  Float          @default(0)
  updatedAt DateTime       @updatedAt
  batch     InventoryBatch @relation(fields: [batchId], references: [id])
  item      InventoryItem  @relation(fields: [itemId], references: [id])
  store     InventoryStore @relation(fields: [storeId], references: [id])

  @@unique([storeId, batchId])
  @@index([storeId])
  @@index([itemId])
  @@index([batchId])
}

model ContractorBatchStock {
  id           String         @id @default(cuid())
  contractorId String
  itemId       String
  batchId      String
  quantity     Float          @default(0)
  updatedAt    DateTime       @updatedAt
  batch        InventoryBatch @relation(fields: [batchId], references: [id])
  contractor   Contractor     @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  item         InventoryItem  @relation(fields: [itemId], references: [id])

  @@unique([contractorId, batchId])
  @@index([contractorId])
  @@index([itemId])
  @@index([batchId])
}

model StockRequest {
  id                        String             @id @default(cuid())
  requestNr                 String             @unique @default(cuid())
  fromStoreId               String?
  toStoreId                 String?
  status                    String             @default("PENDING")
  requestedById             String
  approvedById              String?
  remarks                   String?
  sltReferenceId            String?
  priority                  String             @default("MEDIUM")
  requiredDate              DateTime?
  purpose                   String?
  sourceType                String             @default("SLT")
  projectTypes              String[]
  maintenanceMonths         String?
  workflowStage             String             @default("REQUEST")
  procurementStatus         String             @default("PENDING")
  poNumber                  String?
  vendor                    String?
  expectedDelivery          DateTime?
  irNumber                  String?
  isCoveringPO              Boolean            @default(false)
  armAction                 String?
  armDate                   DateTime?
  armRemarks                String?
  armApprovedById           String?
  storesManagerAction       String?
  storesManagerDate         DateTime?
  storesManagerRemarks      String?
  storesManagerApprovedById String?
  hsOspAction               String?
  hsOspDate                 DateTime?
  managerAction             String?
  managerDate               DateTime?
  releasedById              String?
  releasedDate              DateTime?
  releasedRemarks           String?
  receivedById              String?
  receivedDate              DateTime?
  receivedRemarks           String?
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt
  grns                      GRN[]
  approvedBy                User?              @relation("ApproveUser", fields: [approvedById], references: [id])
  armApprovedBy             User?              @relation("ARMApprover", fields: [armApprovedById], references: [id])
  fromStore                 InventoryStore?    @relation("RequestSource", fields: [fromStoreId], references: [id])
  receivedBy                User?              @relation("ReceivedBy", fields: [receivedById], references: [id])
  releasedBy                User?              @relation("ReleasedBy", fields: [releasedById], references: [id])
  requestedBy               User               @relation("RequestUser", fields: [requestedById], references: [id])
  storesManagerApprovedBy   User?              @relation("StoresManagerApprover", fields: [storesManagerApprovedById], references: [id])
  toStore                   InventoryStore?    @relation("RequestTarget", fields: [toStoreId], references: [id])
  items                     StockRequestItem[]

  @@index([fromStoreId])
  @@index([toStoreId])
  @@index([requestedById])
  @@index([status])
  @@index([workflowStage])
  @@index([createdAt])
}

model StockRequestItem {
  id              String        @id @default(cuid())
  requestId       String
  itemId          String
  requestedQty    Float
  approvedQty     Float         @default(0)
  issuedQty       Float?
  receivedQty     Float         @default(0)
  remarks         String?
  make            String?
  model           String?
  suggestedVendor String?
  createdAt       DateTime      @default(now())
  item            InventoryItem @relation(fields: [itemId], references: [id])
  request         StockRequest  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([itemId])
}

model GRN {
  id           String           @id @default(cuid())
  grnNumber    String           @unique
  storeId      String
  sourceType   String
  supplier     String?
  requestId    String?
  receivedById String
  reference    String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  receivedBy   User             @relation(fields: [receivedById], references: [id])
  request      StockRequest?    @relation(fields: [requestId], references: [id])
  store        InventoryStore   @relation(fields: [storeId], references: [id])
  items        GRNItem[]
  batches      InventoryBatch[]

  @@index([storeId])
  @@index([requestId])
  @@index([grnNumber])
}

model GRNItem {
  id        String          @id @default(cuid())
  grnId     String
  itemId    String
  quantity  Float
  batchId   String?         @unique
  createdAt DateTime        @default(now())
  batch     InventoryBatch? @relation(fields: [batchId], references: [id])
  grn       GRN             @relation(fields: [grnId], references: [id], onDelete: Cascade)
  item      InventoryItem   @relation(fields: [itemId], references: [id])

  @@index([grnId])
  @@index([itemId])
}

model MRN {
  id           String         @id @default(cuid())
  mrnNumber    String         @unique
  storeId      String
  returnType   String
  returnTo     String?
  supplier     String?
  reason       String?
  grnId        String?
  returnedById String
  status       String         @default("PENDING")
  approvedById String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  approvedBy   User?          @relation("MRNApprover", fields: [approvedById], references: [id])
  returnedBy   User           @relation(fields: [returnedById], references: [id])
  store        InventoryStore @relation(fields: [storeId], references: [id])
  items        MRNItem[]

  @@index([storeId])
  @@index([status])
  @@index([mrnNumber])
}

model MRNItem {
  id        String        @id @default(cuid())
  mrnId     String
  itemId    String
  quantity  Float
  reason    String?
  createdAt DateTime      @default(now())
  item      InventoryItem @relation(fields: [itemId], references: [id])
  mrn       MRN           @relation(fields: [mrnId], references: [id], onDelete: Cascade)

  @@index([mrnId])
  @@index([itemId])
}

model InventoryTransaction {
  id          String                     @id @default(cuid())
  type        String
  storeId     String
  referenceId String?
  notes       String?
  date        DateTime                   @default(now())
  userId      String
  store       InventoryStore             @relation(fields: [storeId], references: [id])
  items       InventoryTransactionItem[]

  @@index([storeId])
  @@index([type])
  @@index([date])
}

model InventoryTransactionItem {
  id            String               @id @default(cuid())
  transactionId String
  itemId        String
  quantity      Float
  batchId       String?
  batch         InventoryBatch?      @relation(fields: [batchId], references: [id])
  item          InventoryItem        @relation(fields: [itemId], references: [id])
  transaction   InventoryTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model MaterialCategory {
  id          String             @id @default(cuid())
  name        String             @unique
  description String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  standards   MaterialStandard[]
}

model MaterialStandard {
  id             String           @id @default(cuid())
  categoryId     String
  packageType    String
  itemId         String
  standardQty    Float
  maxQty         Float?
  wastagePercent Float            @default(5)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  category       MaterialCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  item           InventoryItem    @relation("MaterialStandards", fields: [itemId], references: [id])

  @@unique([categoryId, packageType, itemId])
  @@index([packageType])
}

model ContractorMaterialIssue {
  id           String                        @id @default(cuid())
  contractorId String
  storeId      String
  issueDate    DateTime                      @default(now())
  month        String
  issuedBy     String?
  createdAt    DateTime                      @default(now())
  contractor   Contractor                    @relation("MaterialIssues", fields: [contractorId], references: [id], onDelete: Cascade)
  store        InventoryStore                @relation("MaterialIssues", fields: [storeId], references: [id])
  items        ContractorMaterialIssueItem[]

  @@index([contractorId, storeId, month])
  @@index([month])
}

model ContractorMaterialIssueItem {
  id       String                  @id @default(cuid())
  issueId  String
  itemId   String
  quantity Float
  unit     String
  issue    ContractorMaterialIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  item     InventoryItem           @relation("IssueItems", fields: [itemId], references: [id])

  @@index([issueId])
  @@index([itemId])
}

model SODMaterialUsage {
  id             String          @id @default(cuid())
  serviceOrderId String
  itemId         String
  quantity       Float
  unit           String
  usageType      String
  batchId        String?
  unitPrice      Float?          @default(0)
  costPrice      Float?          @default(0)
  wastagePercent Float?
  exceedsLimit   Boolean         @default(false)
  comment        String?
  serialNumber   String?
  approvedBy     String?
  approvedAt     DateTime?
  createdAt      DateTime        @default(now())
  batch          InventoryBatch? @relation(fields: [batchId], references: [id])
  item           InventoryItem   @relation("SODUsage", fields: [itemId], references: [id])
  serviceOrder   ServiceOrder    @relation(fields: [serviceOrderId], references: [id], onDelete: Cascade)

  @@index([serviceOrderId])
  @@index([itemId])
  @@index([usageType])
}

model ContractorMaterialReturn {
  id           String                         @id @default(cuid())
  contractorId String
  storeId      String
  returnDate   DateTime                       @default(now())
  month        String
  reason       String?
  acceptedBy   String?
  acceptedAt   DateTime?
  status       String                         @default("PENDING")
  createdAt    DateTime                       @default(now())
  contractor   Contractor                     @relation("MaterialReturns", fields: [contractorId], references: [id], onDelete: Cascade)
  store        InventoryStore                 @relation("MaterialReturns", fields: [storeId], references: [id])
  items        ContractorMaterialReturnItem[]

  @@index([contractorId, storeId, month])
  @@index([status])
}

model ContractorMaterialReturnItem {
  id        String                   @id @default(cuid())
  returnId  String
  itemId    String
  quantity  Float
  unit      String
  condition String                   @default("GOOD")
  item      InventoryItem            @relation("ReturnItems", fields: [itemId], references: [id])
  return    ContractorMaterialReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@index([returnId])
  @@index([itemId])
}

model ContractorWastage {
  id           String                  @id @default(cuid())
  contractorId String
  storeId      String
  date         DateTime                @default(now())
  month        String
  description  String?
  createdAt    DateTime                @default(now())
  contractor   Contractor              @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  store        InventoryStore          @relation(fields: [storeId], references: [id])
  items        ContractorWastageItem[]

  @@index([contractorId, storeId, month])
}

model ContractorWastageItem {
  id        String            @id @default(cuid())
  wastageId String
  itemId    String
  quantity  Float
  unit      String
  item      InventoryItem     @relation(fields: [itemId], references: [id])
  wastage   ContractorWastage @relation(fields: [wastageId], references: [id], onDelete: Cascade)

  @@index([wastageId])
  @@index([itemId])
}

model ContractorMaterialBalanceSheet {
  id           String                       @id @default(cuid())
  contractorId String
  storeId      String
  month        String
  totalValue   Float?
  usageRate    Float?
  wastageRate  Float?
  generatedAt  DateTime                     @default(now())
  generatedBy  String?
  items        ContractorBalanceSheetItem[]
  contractor   Contractor                   @relation("BalanceSheets", fields: [contractorId], references: [id], onDelete: Cascade)
  store        InventoryStore               @relation("BalanceSheets", fields: [storeId], references: [id])

  @@unique([contractorId, storeId, month])
  @@index([month])
  @@index([contractorId])
  @@index([storeId])
}

model ContractorBalanceSheetItem {
  id             String                         @id @default(cuid())
  balanceSheetId String
  itemId         String
  openingBalance Float
  received       Float
  returned       Float                          @default(0)
  used           Float
  wastage        Float
  closingBalance Float
  requiredNext   Float?
  balanceSheet   ContractorMaterialBalanceSheet @relation(fields: [balanceSheetId], references: [id], onDelete: Cascade)
  item           InventoryItem                  @relation("BalanceSheetItems", fields: [itemId], references: [id])

  @@index([balanceSheetId])
  @@index([itemId])
}

model StockIssue {
  id            String           @id @default(cuid())
  issueNumber   String           @unique
  storeId       String
  issuedById    String
  issueType     String
  projectId     String?
  contractorId  String?
  teamId        String?
  recipientName String
  remarks       String?
  status        String           @default("PENDING")
  approvedById  String?
  approvedAt    DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  approvedBy    User?            @relation("IssueApprover", fields: [approvedById], references: [id])
  contractor    Contractor?      @relation("ContractorIssues", fields: [contractorId], references: [id])
  issuedBy      User             @relation("StockIssuer", fields: [issuedById], references: [id])
  project       Project?         @relation(fields: [projectId], references: [id])
  store         InventoryStore   @relation("StockIssues", fields: [storeId], references: [id])
  items         StockIssueItem[]

  @@index([storeId])
  @@index([issueType])
  @@index([status])
}

model StockIssueItem {
  id        String        @id @default(cuid())
  issueId   String
  itemId    String
  quantity  Float
  remarks   String?
  createdAt DateTime      @default(now())
  issue     StockIssue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  item      InventoryItem @relation("IssueItemsStock", fields: [itemId], references: [id])

  @@index([issueId])
  @@index([itemId])
}

model ProjectMaterialReturn {
  id           String                      @id @default(cuid())
  returnNumber String                      @unique
  projectId    String
  storeId      String
  returnedById String
  status       String                      @default("PENDING")
  approvedById String?
  approvedAt   DateTime?
  reason       String?
  createdAt    DateTime                    @default(now())
  updatedAt    DateTime                    @updatedAt
  approvedBy   User?                       @relation("ProjectReturnApprover", fields: [approvedById], references: [id])
  project      Project                     @relation(fields: [projectId], references: [id])
  returnedBy   User                        @relation("ProjectReturnUser", fields: [returnedById], references: [id])
  store        InventoryStore              @relation(fields: [storeId], references: [id])
  items        ProjectMaterialReturnItem[]

  @@index([projectId])
  @@index([storeId])
  @@index([status])
}

model ProjectMaterialReturnItem {
  id        String                @id @default(cuid())
  returnId  String
  itemId    String
  quantity  Float
  condition String                @default("GOOD")
  remarks   String?
  item      InventoryItem         @relation("ProjectReturnItems", fields: [itemId], references: [id])
  return    ProjectMaterialReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@index([returnId])
  @@index([itemId])
}

model StockMovement {
  id        String   @id @default(cuid())
  storeId   String
  itemId    String
  type      String
  quantity  Float
  reference String?
  remarks   String?
  createdAt DateTime @default(now())

  @@index([storeId])
  @@index([itemId])
  @@index([type])
}

model CurrentStock {
  id        String   @id @default(cuid())
  storeId   String
  itemId    String
  quantity  Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, itemId])
  @@index([storeId])
  @@index([itemId])
}

model Section {
  id              String                  @id @default(cuid())
  name            String                  @unique
  code            String                  @unique
  description     String?
  icon            String?
  color           String?
  isActive        Boolean                 @default(true)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  roles           SystemRole[]
  userAssignments UserSectionAssignment[]
}

model SystemRole {
  id              String                  @id @default(cuid())
  name            String
  code            String                  @unique
  sectionId       String
  description     String?
  level           Int                     @default(1)
  isActive        Boolean                 @default(true)
  permissions     String
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  section         Section                 @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  userAssignments UserSectionAssignment[]

  @@index([sectionId])
}

model UserSectionAssignment {
  id        String     @id @default(cuid())
  userId    String
  sectionId String
  roleId    String
  isPrimary Boolean    @default(false)
  createdAt DateTime   @default(now())
  role      SystemRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  section   Section    @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, sectionId])
  @@index([userId])
  @@index([sectionId])
  @@index([roleId])
}

model SystemConfig {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model Bank {
  id        String       @id @default(cuid())
  code      String       @unique
  name      String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  branches  BankBranch[]
}

model BankBranch {
  id        String   @id @default(cuid())
  bankId    String
  code      String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  bank      Bank     @relation(fields: [bankId], references: [id], onDelete: Cascade)

  @@unique([bankId, code])
}

model SODRevenueConfig {
  id            String    @id @default(cuid())
  rtomId        String?
  revenuePerSOD Float
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  circularRef   String?
  notes         String?
  isActive      Boolean   @default(true)
  createdBy     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  rtom          OPMC?     @relation(fields: [rtomId], references: [id], onDelete: Cascade)

  @@index([rtomId])
  @@index([effectiveFrom, effectiveTo])
  @@index([isActive])
}

model ContractorPaymentConfig {
  id            String                  @id @default(cuid())
  rtomId        String?
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  isActive      Boolean                 @default(true)
  notes         String?
  createdBy     String?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  rtom          OPMC?                   @relation(fields: [rtomId], references: [id], onDelete: Cascade)
  tiers         ContractorPaymentTier[]

  @@index([rtomId])
  @@index([isActive])
}

model ContractorPaymentTier {
  id          String                  @id @default(cuid())
  configId    String
  minDistance Float
  maxDistance Float
  amount      Float
  config      ContractorPaymentConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

model SLTPATStatus {
  id          String    @id @default(cuid())
  soNum       String    @unique
  rtom        String?
  lea         String?
  voiceNumber String?
  sType       String?
  orderType   String?
  task        String?
  package     String?
  conName     String?
  patUser     String?
  status      String
  source      String
  statusDate  DateTime?
  updatedAt   DateTime  @updatedAt

  @@index([status])
  @@index([rtom])
  @@index([soNum])
}

model DashboardStat {
  id              String   @id @default(cuid())
  opmcId          String   @unique
  rtom            String
  pending         Int      @default(0)
  completed       Int      @default(0)
  returned        Int      @default(0)
  patPassed       Int      @default(0)
  patRejected     Int      @default(0)
  sltsPatRejected Int      @default(0)
  lastUpdated     DateTime @updatedAt

  @@index([opmcId])
  @@index([rtom])
}

model ExtensionRawData {
  id          String   @id @default(cuid())
  soNum       String?
  sltUser     String?
  activeTab   String?
  scrapedData Json
  url         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@index([soNum])
  @@index([createdAt])
}

model NotificationPreference {
  id        String   @id @default(cuid())
  userId    String
  type      String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
}

enum Role {
  SUPER_ADMIN
  ADMIN
  MANAGER
  OSP_MANAGER
  AREA_MANAGER
  ENGINEER
  ASSISTANT_ENGINEER
  AREA_COORDINATOR
  QC_OFFICER
  OFFICE_ADMIN
  OFFICE_ADMIN_ASSISTANT
  SITE_OFFICE_STAFF
  FINANCE_MANAGER
  FINANCE_ASSISTANT
  INVOICE_MANAGER
  INVOICE_ASSISTANT
  STORES_MANAGER
  STORES_ASSISTANT
  SA_MANAGER
  SA_ASSISTANT
  PROCUREMENT_OFFICER
}

enum ContractorStatus {
  ACTIVE
  INACTIVE
  PENDING
  ARM_PENDING
  OSP_PENDING
  REJECTED
}

enum ContractorType {
  SOD
  OSP
}
